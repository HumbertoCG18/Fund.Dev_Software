<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lojas ACME - Sistema de Vendas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f0f0f0;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }

        h2 {
            margin-top: 0;
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: 1px solid #2980b9;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:active {
            transform: scale(0.98);
        }

        button.remove {
            background-color: #e74c3c;
            border-color: #c0392b;
        }

        button.remove:hover {
            background-color: #c0392b;
        }

        button.add {
            background-color: #2ecc71;
            border-color: #27ae60;
        }

        button.add:hover {
            background-color: #27ae60;
        }

        .result {
            background-color: #e9ecef;
            border: 1px solid #000000;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            overflow: auto;
            max-height: 300px;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        input,
        select {
            padding: 10px;
            margin: 5px 0 10px 0; /* Ajustado para inputs e selects ficarem abaixo dos labels */
            border: 1px solid #000000;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%; /* Ocupar largura total disponível */
        }

        input[type="number"] {
            width: 120px; /* Largura específica para números, pode ajustar */
        }
        
        #formProduto div { margin-bottom: 12px; } /* Espaçamento entre os campos do formulário */
        #formProduto label {
            display: block; /* Labels em sua própria linha */
            margin-bottom: 3px; /* Pequeno espaço abaixo do label */
            font-weight: bold;
        }


        .item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item select.prodId {
            flex-grow: 1;
        }

        .item input.prodQtd {
            width: 70px;
            flex-shrink: 0;
        }

        .item button.remove {
            flex-shrink: 0;
        }

        .actions {
            margin-top: 15px;
        }

        .loading {
            color: #3498db;
            font-style: italic;
        }

        .error {
            color: #e74c3c;
            font-weight: bold;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e74c3c;
        }

        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-card p {
            margin: 8px 0;
        }

        .product-id {
            font-weight: bold;
            color: #007bff;
        }

        .product-price {
            color: #28a745;
            font-weight: bold;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        #listaOrcamentosParaGerenciar ul {
            list-style-type: none;
            padding: 0;
        }

        #listaOrcamentosParaGerenciar li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        #listaOrcamentosParaGerenciar li .orc-info {
            flex-grow: 1;
            margin-right: 10px;
            min-width: 200px; 
        }

        #listaOrcamentosParaGerenciar li .orc-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
         /* Remover regra CSS vazia .item button {} */
    </style>
</head>

<body>
    <h1>Lojas ACME - Sistema de Vendas</h1>

    <div class="card">
        <h2 id="produtoFormTitulo">Adicionar Novo Produto</h2>
        <form id="formProduto">
            <input type="hidden" id="produtoIdForm">
            <div>
                <label for="produtoDescricao">Descrição do Produto:</label>
                <input type="text" id="produtoDescricao" required>
            </div>
            <div>
                <label for="produtoPreco">Preço Unitário (R$):</label>
                <input type="number" id="produtoPreco" step="0.01" min="0" required>
            </div>
            <div id="estoqueInicialDiv">
                <div>
                    <label for="produtoEstoqueInicial">Estoque Inicial:</label>
                    <input type="number" id="produtoEstoqueInicial" min="0" value="10">
                </div>
                <div>
                    <label for="produtoEstoqueMin">Estoque Mínimo:</label>
                    <input type="number" id="produtoEstoqueMin" min="0" value="5">
                </div>
                <div>
                    <label for="produtoEstoqueMax">Estoque Máximo:</label>
                    <input type="number" id="produtoEstoqueMax" min="0" value="50">
                </div>
            </div>
            <div class="button-group">
                <button type="button" onclick="submeterFormularioProduto()">Salvar Produto</button>
                <button type="button" onclick="limparEPrepararFormularioProduto()">Novo/Limpar</button>
            </div>
        </form>
        <p style="font-size: 0.9em; color: #555;">Para editar, clique em "Editar Produto" na lista abaixo. Os dados serão carregados no formulário.</p>
        <div id="produtoFormResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h2>Produtos Disponíveis</h2>
        <div class="button-group">
            <button onclick="exibirProdutosComoJson()">Listar Produtos (JSON)</button>
        </div>
        <div id="produtosContainer" class="product-list"></div>
        <div id="produtosResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h2>Criar Novo Orçamento</h2>
        <p>Adicione produtos ao orçamento:</p>
        <div id="itensOrcamento">
            </div>
        <div class="button-group">
            <button class="add" onclick="adicionarLinhaDeItemParaOrcamento()">Adicionar Item</button>
        </div>
        <div class="actions button-group">
            <button onclick="submeterNovoOrcamento()">Criar Orçamento</button>
        </div>
        <div id="orcamentoResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h2>Gerenciar Orçamentos Existentes</h2>
        <div id="listaOrcamentosParaGerenciar">
            </div>
        <div id="gerenciarOrcamentoResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h2>Últimos Orçamentos Efetivados (Relatório)</h2>
        <div>
            <label for="numOrcamentos">Quantidade:</label>
            <input type="number" id="numOrcamentos" placeholder="N" value="5" min="1" style="width:100px;">
        </div>
        <div class="button-group">
            <button onclick="buscarUltimosOrcamentosEfetivados()">Buscar Relatório</button>
        </div>
        <div id="ultimosResult" class="result" style="display: none;"></div>
    </div>

    <script>
        let produtosDisponiveis = [];
        let orcamentosCarregados = [];

        async function handleFetchError(response) {
            if (!response.ok) {
                let errorMsg = `Erro ${response.status}: ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorMsg = `Erro ${response.status}: ${errorData.message || response.statusText}`;
                } catch (e) { /* Mantém msg original se JSON falhar */ }
                throw new Error(errorMsg);
            }
            if (response.status === 204) return null; // Para DELETE bem-sucedido
            return response.json();
        }

        window.onload = async function () {
            await carregarProdutosDisponiveis();
            await carregarTodosOrcamentosParaGerenciamento();
            adicionarLinhaDeItemParaOrcamento();
            limparEPrepararFormularioProduto();
        };

        async function carregarProdutosDisponiveis() {
            try {
                const response = await fetch('/produtosDisponiveis');
                produtosDisponiveis = await handleFetchError(response);
                renderizarProdutosComoCards();
                atualizarTodosOsSeletoresDeProduto();
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                exibirResultadoOperacao('produtosResult', 'Falha ao carregar produtos: ' + error.message, 'error');
            }
        }

        function renderizarProdutosComoCards() {
            const container = document.getElementById('produtosContainer');
            container.innerHTML = '';
            if (!produtosDisponiveis || produtosDisponiveis.length === 0) {
                container.innerHTML = '<p>Nenhum produto disponível no estoque no momento.</p>';
                return;
            }
            produtosDisponiveis.forEach(produto => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'product-card';
                cardDiv.innerHTML = `
                    <div>
                        <p class="product-id">ID: ${produto.id}</p>
                        <p><strong>${produto.descricao}</strong></p>
                        <p class="product-price">R$ ${(produto.precoUnitario || 0).toFixed(2)}</p>
                    </div>
                    <div class="button-group" style="margin-top: auto;">
                        <button onclick="prepararFormularioParaEditarProduto(${produto.id})">Editar</button>
                        <button class="remove" onclick="removerProdutoPeloCard(${produto.id}, '${produto.descricao.replace(/'/g, "\\'")}')">Remover</button>
                    </div>
                `;
                container.appendChild(cardDiv);
            });
        }

        async function carregarTodosOrcamentosParaGerenciamento() {
            try {
                const response = await fetch('/todosOrcamentos');
                orcamentosCarregados = await handleFetchError(response);
                renderizarListaDeOrcamentos();
            } catch (error) {
                console.error('Erro ao carregar orçamentos:', error);
                exibirResultadoOperacao('gerenciarOrcamentoResult', 'Falha ao carregar lista de orçamentos: ' + error.message, 'error');
            }
        }

        function atualizarTodosOsSeletoresDeProduto() {
            const seletores = document.querySelectorAll('select.prodId');
            seletores.forEach(seletor => {
                const valorAtual = seletor.value;
                seletor.innerHTML = '<option value="">Selecione um produto...</option>';
                if (produtosDisponiveis) {
                    produtosDisponiveis.forEach(produto => {
                        const option = document.createElement('option');
                        option.value = produto.id;
                        option.textContent = `${produto.id} - ${produto.descricao} (R$ ${(produto.precoUnitario || 0).toFixed(2)})`;
                        seletor.appendChild(option);
                    });
                }
                if (valorAtual) seletor.value = valorAtual;
            });
        }

        function renderizarListaDeOrcamentos() {
            const divLista = document.getElementById('listaOrcamentosParaGerenciar');
            divLista.innerHTML = '';

            if (!orcamentosCarregados || orcamentosCarregados.length === 0) {
                divLista.innerHTML = '<p>Nenhum orçamento encontrado para gerenciar.</p>';
                return;
            }
            const ul = document.createElement('ul');
            orcamentosCarregados.forEach(orc => {
                const li = document.createElement('li');
                const status = orc.efetivado ? '<span style="color: green;">(EFETIVADO)</span>' : '<span style="color: orange;">(PENDENTE)</span>';
                let botoesAcao = '<div class="orc-actions">';
                if (!orc.efetivado) {
                    botoesAcao += `<button onclick="efetivarOrcamentoDaLista(${orc.id})">Efetivar</button>`;
                }
                botoesAcao += `<button class="remove" onclick="removerOrcamentoDaLista(${orc.id})">Remover</button>`;
                botoesAcao += '</div>';

                li.innerHTML = `<span class="orc-info"><strong>Orçamento #${orc.id}</strong> - Total: R$ ${(orc.custoConsumidor || 0).toFixed(2)} ${status}</span> ${botoesAcao}`;
                ul.appendChild(li);
            });
            divLista.appendChild(ul);
        }

        function formatarComoJson(data) { return JSON.stringify(data, null, 2); }

        function exibirResultadoOperacao(elementId, data, tipo = 'normal') {
            const el = document.getElementById(elementId);
            if (!el) { console.error("Elemento de resultado não encontrado:", elementId); return; }
            el.style.display = 'block';
            el.classList.remove('loading', 'error');

            if (tipo === 'loading') {
                el.classList.add('loading');
                el.innerHTML = typeof data === 'string' ? data : 'Processando...';
            } else if (tipo === 'error') {
                el.classList.add('error');
                el.innerHTML = typeof data === 'string' ? data : 'Ocorreu um erro.';
            } else {
                el.innerHTML = (typeof data === 'object' && data !== null) ? formatarComoJson(data) : (data === null ? 'Operação concluída.' : data);
            }
        }

        async function exibirProdutosComoJson() {
            try {
                exibirResultadoOperacao('produtosResult', 'Buscando produtos...', 'loading');
                const response = await fetch('/produtosDisponiveis');
                const dados = await handleFetchError(response);
                exibirResultadoOperacao('produtosResult', dados);
            } catch (error) {
                exibirResultadoOperacao('produtosResult', 'Falha ao buscar produtos: ' + error.message, 'error');
            }
        }

        function adicionarLinhaDeItemParaOrcamento() {
            const container = document.getElementById('itensOrcamento');
            const novaLinha = document.createElement('div');
            novaLinha.className = 'item';
            novaLinha.innerHTML = `
                <select class="prodId"><option value="">Selecione...</option></select>
                <input type="number" placeholder="Qtd" class="prodQtd" min="1" value="1">
                <button class="remove" onclick="this.parentElement.remove()">Remover</button>
            `;
            container.appendChild(novaLinha);
            atualizarTodosOsSeletoresDeProduto();
        }

        async function submeterNovoOrcamento() {
            const itens = [];
            document.querySelectorAll('#itensOrcamento .item').forEach(div => {
                const sel = div.querySelector('.prodId');
                const qtd = div.querySelector('.prodQtd');
                if (sel.value && qtd.value && parseInt(qtd.value) > 0) {
                    itens.push({ idProduto: parseInt(sel.value), qtdade: parseInt(qtd.value) });
                }
            });
            if (itens.length === 0) {
                exibirResultadoOperacao('orcamentoResult', 'Adicione itens válidos ao orçamento.', 'error'); return;
            }
            exibirResultadoOperacao('orcamentoResult', 'Criando orçamento...', 'loading');
            try {
                const response = await fetch('/novoOrcamento', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(itens)
                });
                const orcCriado = await handleFetchError(response);
                exibirResultadoOperacao('orcamentoResult', orcCriado);
                document.getElementById('itensOrcamento').innerHTML = '';
                adicionarLinhaDeItemParaOrcamento();
                await carregarTodosOrcamentosParaGerenciamento();
            } catch (error) {
                exibirResultadoOperacao('orcamentoResult', 'Erro ao criar orçamento: ' + error.message, 'error');
            }
        }

        function limparEPrepararFormularioProduto() {
            document.getElementById('formProduto').reset();
            document.getElementById('produtoIdForm').value = '';
            document.getElementById('estoqueInicialDiv').style.display = 'block';
            document.getElementById('produtoFormTitulo').textContent = 'Adicionar Novo Produto';
            document.getElementById('produtoDescricao').focus();
            const resultDiv = document.getElementById('produtoFormResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'none';
        }

        function prepararFormularioParaEditarProduto(produtoId) {
            const produto = produtosDisponiveis.find(p => p.id === produtoId);
            if (produto) {
                document.getElementById('produtoFormTitulo').textContent = `Editando Produto ID: ${produto.id}`;
                document.getElementById('produtoIdForm').value = produto.id;
                document.getElementById('produtoDescricao').value = produto.descricao;
                document.getElementById('produtoPreco').value = produto.precoUnitario;
                document.getElementById('estoqueInicialDiv').style.display = 'none';
                const resultDiv = document.getElementById('produtoFormResult');
                resultDiv.innerHTML = '';
                resultDiv.style.display = 'none';
                document.getElementById('formProduto').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function submeterFormularioProduto() {
            const id = document.getElementById('produtoIdForm').value;
            const descricao = document.getElementById('produtoDescricao').value.trim();
            const precoStr = document.getElementById('produtoPreco').value;

            if (!descricao) { exibirResultadoOperacao('produtoFormResult', 'Descrição é obrigatória.', 'error'); return; }
            if (!precoStr) { exibirResultadoOperacao('produtoFormResult', 'Preço é obrigatório.', 'error'); return; }
            const preco = parseFloat(precoStr);
            if (isNaN(preco) || preco < 0) { exibirResultadoOperacao('produtoFormResult', 'Preço inválido.', 'error'); return; }

            let url = '/produtos';
            let method = 'POST';
            let payload;

            if (id) { 
                method = 'PUT';
                url += `/${id}`;
                payload = { id: parseInt(id), descricao, precoUnitario: preco };
            } else { 
                const qtdIni = parseInt(document.getElementById('produtoEstoqueInicial').value);
                const estMin = parseInt(document.getElementById('produtoEstoqueMin').value);
                const estMax = parseInt(document.getElementById('produtoEstoqueMax').value);
                if (isNaN(qtdIni) || qtdIni < 0 || isNaN(estMin) || estMin < 0 || isNaN(estMax) || estMax < estMin) {
                    exibirResultadoOperacao('produtoFormResult', 'Valores de estoque inválidos.', 'error'); return;
                }
                payload = { descricao, precoUnitario: preco, quantidadeInicialEstoque: qtdIni, estoqueMin: estMin, estoqueMax: estMax };
            }

            exibirResultadoOperacao('produtoFormResult', 'Salvando produto...', 'loading');
            try {
                const response = await fetch(url, {
                    method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const salvo = await handleFetchError(response);
                exibirResultadoOperacao('produtoFormResult', `Produto ${id ? 'atualizado' : 'adicionado'} com sucesso! ${salvo ? `(ID: ${salvo.id})` : ''}`, 'normal');
                limparEPrepararFormularioProduto();
                await carregarProdutosDisponiveis();
            } catch (error) {
                exibirResultadoOperacao('produtoFormResult', `Erro ao salvar produto: ${error.message}`, 'error');
            }
        }

        async function efetivarOrcamentoDaLista(orcamentoId) {
            if (!orcamentoId) { exibirResultadoOperacao('gerenciarOrcamentoResult', 'ID inválido.', 'error'); return; }
            exibirResultadoOperacao('gerenciarOrcamentoResult', `Efetivando orçamento #${orcamentoId}...`, 'loading');
            try {
                const response = await fetch(`/efetivaOrcamento/${orcamentoId}`);
                const orcProcessado = await handleFetchError(response);
                exibirResultadoOperacao('gerenciarOrcamentoResult', orcProcessado);
                await carregarTodosOrcamentosParaGerenciamento();
            } catch (error) {
                exibirResultadoOperacao('gerenciarOrcamentoResult', `Erro ao efetivar orçamento #${orcamentoId}: ${error.message}`, 'error');
            }
        }

        async function removerOrcamentoDaLista(orcamentoId) {
            if (!orcamentoId) { exibirResultadoOperacao('gerenciarOrcamentoResult', 'ID inválido.', 'error'); return; }
            if (!confirm(`Remover orçamento #${orcamentoId}? Esta ação não pode ser desfeita.`)) return;
            
            exibirResultadoOperacao('gerenciarOrcamentoResult', `Removendo orçamento #${orcamentoId}...`, 'loading');
            try {
                const response = await fetch(`/orcamentos/${orcamentoId}`, { method: 'DELETE' });
                await handleFetchError(response); // Lida com 204 (null) ou erros
                exibirResultadoOperacao('gerenciarOrcamentoResult', `Orçamento #${orcamentoId} removido.`, 'normal');
                await carregarTodosOrcamentosParaGerenciamento();
            } catch (error) {
                exibirResultadoOperacao('gerenciarOrcamentoResult', `Erro ao remover orçamento #${orcamentoId}: ${error.message}`, 'error');
            }
        }
        
        async function removerProdutoPeloCard(produtoId, produtoDescricao) {
            if (!produtoId) { exibirResultadoOperacao('produtosResult', 'ID do produto inválido.', 'error'); return; }
            if (!confirm(`Remover o produto "${produtoDescricao}" (ID: ${produtoId})?\nOrçamentos pendentes que contêm este produto serão atualizados.`)) return;

            exibirResultadoOperacao('produtosResult', `Removendo produto ID ${produtoId}...`, 'loading');
            try {
                const response = await fetch(`/produtos/${produtoId}`, { method: 'DELETE' });
                await handleFetchError(response); // Lida com 204 (null) ou erros
                exibirResultadoOperacao('produtosResult', `Produto ID ${produtoId} removido. Orçamentos atualizados.`, 'normal');
                await carregarProdutosDisponiveis(); 
                await carregarTodosOrcamentosParaGerenciamento(); 
            } catch (error) {
                exibirResultadoOperacao('produtosResult', `Erro ao remover produto ID ${produtoId}: ${error.message}`, 'error');
            }
        }


        async function buscarUltimosOrcamentosEfetivados() {
            const n = document.getElementById('numOrcamentos').value || 5;
            exibirResultadoOperacao('ultimosResult', `Buscando ${n} orçamentos...`, 'loading');
            try {
                const response = await fetch(`/orcamentosEfetivados?n=${n}`);
                const dados = await handleFetchError(response);
                exibirResultadoOperacao('ultimosResult', dados);
            } catch (error) {
                exibirResultadoOperacao('ultimosResult', 'Erro: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>